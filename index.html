<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>年賀AR</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }

    /* A-Frameのcanvasが「変な拡大・台形・荒れ」に繋がるのを防ぐ */
    canvas.a-canvas {
      position: fixed !important;
      top: 0; left: 0;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover;   /* 引き伸ばしを避けて、足りない分はトリミング */
    }

    .ui {
      position: fixed;
      left: 0; right: 0; top: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font: 14px/1.4 system-ui, -apple-system, "Segoe UI", sans-serif;
      z-index: 10;
    }
  </style>
</head>

<body>
  <div class="ui">カメラを許可 → <b>Hiroマーカー</b>にかざしてください</div>

  <!--
    改善ポイント
    - facingMode: environment で背面固定（ズーム/歪み/荒れの原因が前面カメラだったケースを排除）
    - sourceWidth/sourceHeight を上げて「ドット絵」を抑える
    - displayWidth/displayHeight も指定して表示側の崩れを抑える
  -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true; precision: mediump;"
    arjs="
      sourceType: webcam;
      facingMode: environment;
      debugUIEnabled: false;

      sourceWidth: 1280;
      sourceHeight: 720;

      displayWidth: 1280;
      displayHeight: 720;
    "
  >
    <!-- ズーム感が強い場合は fov を上げる（70〜80が効きやすい） -->
    <a-entity camera="fov: 75;"></a-entity>

    <a-marker preset="hiro">
      <!-- これはマーカー上の表示。背景が壊れてる問題とは別なので最低限でOK -->
      <a-image
        src="overlay.png"
        position="0 0 0"
        rotation="-90 0 0"
        width="1.4"
        height="1.4"
        transparent="true"
        alpha-test="0.1"
      ></a-image>
    </a-marker>

    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
  </a-scene>

  <script>
    // ブラウザが低いレンダリング解像度を選んだときの救済（ドット絵感を減らす）
    // ※端末によっては効かないこともあるが、害はない
    window.addEventListener("load", () => {
      const scene = document.querySelector("a-scene");
      scene.addEventListener("renderstart", () => {
        try {
          const r = scene.renderer;
          if (r && window.devicePixelRatio) r.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        } catch (_) {}
      });
    });
  </script>
</body>
</html>
