<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>年賀状AR（QRトリガー）</title>

<!-- QR認識ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#000;
  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
}

/* カメラ映像 */
#cam{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:0;
}

/* 動く絵（動画） */
#overlay{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  display:none;
  z-index:2;
  pointer-events:none;
}

/* UI */
#ui{
  position:fixed;
  inset:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.85);
}
button{
  padding:16px 24px;
  font-size:18px;
  font-weight:800;
  border-radius:14px;
  border:none;
}
#hint{
  position:fixed;
  bottom:12px;
  left:0; right:0;
  text-align:center;
  color:#fff;
  opacity:.9;
  z-index:3;
  font-size:14px;
  display:none;
}
canvas{display:none}
</style>
</head>

<body>

<video id="cam" autoplay muted playsinline></video>

<!-- 年賀状の「動く絵」 -->
<video id="overlay" src="./overlay.mp4" loop muted playsinline></video>

<div id="ui">
  <button id="start">開始</button>
</div>

<div id="hint">QRをカメラに映してください</div>

<canvas id="cv"></canvas>

<script>
const cam = document.getElementById('cam');
const overlay = document.getElementById('overlay');
const ui = document.getElementById('ui');
const hint = document.getElementById('hint');
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { willReadFrequently:true });

let running = false;
let lastFound = 0;

async function start(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}},
    audio:false
  });
  cam.srcObject = stream;
  await cam.play();

  // iOS対策：ユーザー操作で触る
  try{ await overlay.play(); }catch(e){}
  overlay.pause();
  overlay.currentTime = 0;

  ui.style.display='none';
  hint.style.display='block';
  running = true;
  tick();
}

function tick(){
  if(!running) return;

  if(cam.videoWidth){
    const w = 320;
    const h = Math.round(cam.videoHeight * (w / cam.videoWidth));
    cv.width = w;
    cv.height = h;

    ctx.drawImage(cam,0,0,w,h);
    const img = ctx.getImageData(0,0,w,h);

    const code = jsQR(img.data, img.width, img.height);

    if(code){
      lastFound = performance.now();
      if(overlay.style.display!=='block'){
        overlay.style.display='block';
        overlay.play();
      }
    }else{
      if(performance.now() - lastFound > 500){
        overlay.pause();
        overlay.currentTime = 0;
        overlay.style.display='none';
      }
    }
  }
  requestAnimationFrame(tick);
}

document.getElementById('start').onclick = start;
</script>

</body>
</html>
