<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>年賀状AR（QRトリガー / 500×740 固定表示）</title>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
html,body{
  margin:0; height:100%; overflow:hidden; background:#000;
  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
}

/* カメラ（背景） */
#cam{
  position:fixed; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  background:#000;
}

/* 中央に“年賀状比率”で固定表示する動画（歪みゼロ） */
#overlay{
  position:fixed;
  left:50%;
  top:48%;                          /* 少し上寄せ（好みで調整可） */
  transform:translate(-50%,-50%);
  height:min(72vh, 740px);          /* 高さ基準で安定 */
  aspect-ratio: 500 / 740;          /* ★ 500×740 ぴったり */
  display:none;
  pointer-events:none;
  filter: drop-shadow(0 6px 18px rgba(0,0,0,.45));
  border-radius: 10px;
}

/* 起動UI */
#ui{
  position:fixed; inset:0; z-index:10;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.85);
}
#panel{
  width:min(92vw, 520px);
  color:#fff; text-align:left;
}
button{
  width:100%;
  font-size:18px; font-weight:900;
  padding:16px 18px; border-radius:14px; border:0;
}
#hint{
  margin-top:10px; opacity:.85; font-size:13px; line-height:1.4;
}
#status{
  margin-top:10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size:12px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:12px;
  padding:10px;
  white-space:pre-wrap;
}

canvas{ display:none }
</style>
</head>

<body>

<video id="cam" autoplay muted playsinline></video>

<!-- 中央表示動画（500×740） -->
<video id="overlay" src="./overlay.mp4" loop muted playsinline webkit-playsinline></video>

<!-- 同時再生音声 -->
<audio id="snd" src="./sound.mp3" preload="auto"></audio>

<div id="ui">
  <div id="panel">
    <button id="start">開始（カメラ許可）</button>
    <div id="hint">
      1) 「開始」を押す<br>
      2) 年賀状の左下のQRを一度だけ映す<br>
      3) 中央の動画（500×740）＋音声が再生されます
    </div>
    <div id="status">state: idle</div>
  </div>
</div>

<canvas id="cv"></canvas>

<script>
const cam = document.getElementById('cam');
const ov  = document.getElementById('overlay');
const snd = document.getElementById('snd');
const ui  = document.getElementById('ui');
const cv  = document.getElementById('cv');
const ctx = cv.getContext('2d', { willReadFrequently:true });
const statusEl = document.getElementById('status');

let running=false;
let scanning=false;
let audioReady=false;
let audioPlaying=false;

/* QR検出の軽量設定 */
const DETECT_EVERY = 2;   // 2～3 推奨
let frame=0;

/* 特定のQRだけ反応させたい場合は文字列を入れる
   例: const EXPECT_QR_TEXT = "NENGA2026";
   null のままなら「どのQRでもOK」 */
const EXPECT_QR_TEXT = null;

function log(t){ statusEl.textContent = t; }

/* 音声の事前アンロック */
async function armAudio(){
  try{
    snd.currentTime=0;
    await snd.play();
    snd.pause();
    snd.currentTime=0;
    audioReady=true;
  }catch(e){}
}

/* 可能な限り高解像度を要求（端末依存） */
async function getStreamBestEffort(){
  const tries = [
    { video:{ facingMode:{ideal:'environment'}, width:{exact:3840}, height:{exact:2160} }, audio:false },
    { video:{ facingMode:{ideal:'environment'}, width:{min:1920}, height:{min:1080} }, audio:false },
    { video:{ facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false },
    { video:{ facingMode:{ideal:'environment'} }, audio:false },
  ];
  for(const c of tries){
    try{ return await navigator.mediaDevices.getUserMedia(c); }catch(e){}
  }
  return await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
}

async function start(){
  log("state: starting...");
  const stream = await getStreamBestEffort();
  cam.srcObject = stream;
  await cam.play();

  const track = stream.getVideoTracks()[0];
  const s = track.getSettings?.() || {};
  log(`state: camera ok (${s.width||"?"}x${s.height||"?"}) / scanning qr...`);

  /* overlay は検出後に表示 */
  try{ await ov.play(); }catch(_){}
  ov.pause(); ov.currentTime=0; ov.style.display="none";

  await armAudio();

  ui.style.display="none";
  running=true;
  scanning=true;
  requestAnimationFrame(tick);
}

function playAR(){
  if(ov.style.display!=="block"){
    ov.style.display="block";
    ov.currentTime=0;
    ov.play().catch(()=>{});
  }
  if(audioReady && !audioPlaying){
    snd.currentTime=0;
    snd.play().then(()=>audioPlaying=true).catch(()=>{});
  }
}

function tick(){
  if(!running) return;
  frame++;

  if(cam.videoWidth && scanning && frame % DETECT_EVERY === 0){
    /* 検出は軽量化のため縮小（表示品質とは無関係） */
    const sw = 420; // 鈍さ対策で少し大きめ
    const sh = Math.round(cam.videoHeight * (sw / cam.videoWidth));
    cv.width=sw; cv.height=sh;
    ctx.drawImage(cam,0,0,sw,sh);
    const img = ctx.getImageData(0,0,sw,sh);

    const code = jsQR(img.data, sw, sh, { inversionAttempts:"attemptBoth" });
    if(code){
      if(EXPECT_QR_TEXT===null || (code.data||"").trim()===EXPECT_QR_TEXT){
        playAR();
        scanning=false; // 一度読めたら終了（安定）
      }
    }
  }

  requestAnimationFrame(tick);
}

document.getElementById('start').onclick = start;
</script>

</body>
</html>
