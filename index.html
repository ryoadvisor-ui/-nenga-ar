<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>年賀状AR（MindAR・無料）</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    #ui{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; gap:12px;
      background:rgba(0,0,0,.75); color:#fff;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      padding:20px; text-align:center;
    }
    button{ padding:12px 16px; border:0; border-radius:12px; font-size:16px; font-weight:700; }
    #msg{ font-size:13px; opacity:.9; line-height:1.6; min-height:3.2em; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.35); border-radius:999px; font-size:12px; opacity:.9; }
    #bar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  </style>
</head>

<body>
  <div id="ui">
    <div style="font-size:18px;font-weight:700;">年賀状ARを開始</div>
    <div id="bar">
      <span class="pill" id="st">state: boot</span>
      <span class="pill" id="er">error: -</span>
    </div>
    <div id="msg">読み込み中…（数秒待ってください）</div>
    <button id="startBtn" disabled>開始</button>
    <div style="font-size:12px;opacity:.75;line-height:1.5;">
      ①開始 → ②カメラ許可 → ③年賀状にかざす<br>
      ※iPhoneは開始ボタン必須
    </div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: false; uiLoading: false;"
    renderer="colorManagement: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <video id="ov" src="./overlay.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-video src="#ov" width="1.0" height="0.56" position="0 0 0"></a-video>
    </a-entity>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    const ui = document.getElementById('ui');
    const msg = document.getElementById('msg');
    const st  = document.getElementById('st');
    const er  = document.getElementById('er');
    const startBtn = document.getElementById('startBtn');

    const scene = document.querySelector('a-scene');
    const overlayVideo = document.getElementById('ov');

    function setState(t){ st.textContent = 'state: ' + t; }
    function setErr(t){ er.textContent = 'error: ' + t; }
    function setMsg(t){ msg.textContent = t; }

    async function exists(url){
      try{
        const r = await fetch(url, { cache: 'no-store' });
        return r.ok;
      }catch(_){
        return false;
      }
    }

    // 1) ページ読み込み直後：ファイル存在チェック→MindARの準備完了待ち
    window.addEventListener('load', async () => {
      setState('checking');

      // ファイル存在確認（ここで原因を潰す）
      const okMind = await exists('./targets.mind');
      const okMp4  = await exists('./overlay.mp4');

      if (!okMind) {
        setState('blocked');
        setErr('targets.mind not found');
        setMsg('targets.mind が見つかりません（index.htmlと同じ階層に置いてください）');
        return;
      }
      if (!okMp4) {
        setState('blocked');
        setErr('overlay.mp4 not found');
        setMsg('overlay.mp4 が見つかりません（index.htmlと同じ階層に置いてください）');
        return;
      }

      // A-Frameの初期化が終わるまで待つ（ここがTypeError対策の本丸）
      scene.addEventListener('loaded', () => {
        // mindar-image コンポーネントが載るまで少し待つ
        const waitMindar = setInterval(() => {
          const mindar = scene.components && scene.components['mindar-image'];
          if (mindar && typeof mindar.start === 'function') {
            clearInterval(waitMindar);
            setState('ready');
            setErr('-');
            setMsg('準備OK。「開始」を押してください。');
            startBtn.disabled = false;
          }
        }, 100);
        setTimeout(() => {
          if (startBtn.disabled) {
            setState('timeout');
            setErr('mindar init timeout');
            setMsg('MindARの初期化に失敗しました。通信制限/読み込みブロックの可能性があります。');
          }
        }, 8000);
      });
    });

    // 2) 開始ボタン：ユーザー操作の中で start する
    startBtn.addEventListener('click', async () => {
      try{
        setState('starting');
        setErr('-');
        setMsg('起動中…（カメラ許可が出たら許可してください）');

        // iOS対策：ユーザー操作中に動画再生トライ（失敗してもOK）
        try { await overlayVideo.play(); } catch(_){}

        const mindar = scene.components['mindar-image'];
        await mindar.start();

        // 起動成功
        ui.style.display = 'none';
        setState('running');

      }catch(e){
        setState('failed');
        setErr(e?.name || String(e));
        setMsg('起動失敗：' + (e?.name || e));
      }
    });

    // 認識イベント（成功確認）
    scene.addEventListener('targetFound', async () => {
      try { await overlayVideo.play(); } catch(_){}
    });
  </script>
</body>
</html>
